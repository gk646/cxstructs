name: Build include dir on commit

on: [ push ]

jobs:
  copy_files:
    runs-on: ubuntu-latest
    steps:

      - name: Checkout code
        uses: actions/checkout@v2

      - name: Copy Files
        run: |
          rm -rf include/*
          rm -rf include/cxstructs
          rm -rf include/cxalgos
          rm -rf include/machinelearning
          
          mkdir -p include/cxstructs
          mkdir -p include/cxalgos
          mkdir -p include/machinelearning
          
          
          for file in $(find src -maxdepth 1 -name '*.h' -or -name '*.cpp'); do
            if sed -n '20p' $file | grep -q "#define FINISHED"; then
              filename=$(basename $file)
              cp $file ./include/$filename
            fi
          done
          
          for file in $(find src/datastructures -name '*.h' -or -name '*.cpp'); do
            if sed -n '20p' $file | grep -q "#define FINISHED"; then
              filename=$(basename $file)
              cp $file ./include/cxstructs/$filename
            fi
          done
          
          for file in $(find src/algorithms -name '*.h' -or -name '*.cpp'); do
            if sed -n '20p' $file | grep -q "#define FINISHED"; then
              filename=$(basename $file)
              cp $file ./include/cxalgos/$filename
            fi
          done
          
          for file in $(find src/machinelearning -name '*.h' -or -name '*.cpp'); do
            if sed -n '20p' $file | grep -q "#define FINISHED"; then
              filename=$(basename $file)
              cp $file ./include/machinelearning/$filename
            fi
          done
          
          for file in include/cxstructs/*.h; do
            sed -i '/#ifndef CX_DELETE_TESTS/,/#endif/ { /#ifndef CX_DELETE_TESTS/ {N; d;}; /#endif/ d; }' "$file"
          done
          
          for file in include/cxalgos/*.h; do
            sed -i '/#ifndef CX_DELETE_TESTS/,/#endif/ { /#ifndef CX_DELETE_TESTS/ {N; d;}; /#endif/ d; }' "$file"
          done
          
          for file in include/cxml/*.h; do
            sed -i '/#ifndef CX_DELETE_TESTS/,/#endif/ { /#ifndef CX_DELETE_TESTS/ {N; d;}; /#endif/ d; }' "$file"
          done

      - name: Commit and push on change
        run: |
          git diff
          git add include/*
          git config --global user.email "action@github.com"
          git config --global user.name "GitHub Action"
          git commit -am "Auto commit copied files" || exit 0
          git push